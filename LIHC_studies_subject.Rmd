---
title: "RNA-seq data normalization"
subtitle: "Layla Saad Montoya internship"
author: " Florent Chuffart"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---

# Introduction

## Libraries

```{r, echo=FALSE, eval=TRUE, label="Loading libraries . . ."}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=FALSE, results="hide", dpi=75)
```

## Data

### Features

File containing the information on every gene in the geneset.

```{r, label = "Loading file . . .", results='asis'}
features_filename = "features_cpsf3.rds"
features = readRDS(features_filename)
```

```{r}
complex = c(
  SSU72    = 1,  #    SSU72  29101
  LSM10    = 2,  #    LSM10  84967
  SNRPE    = 2,  #    SNRPE   6635
  CPSF3    = 3, #    CPSF3  51692
  SNRPG    = 2,  #    SNRPG   6637
  WDR33    = 1, #    WDR33  55339
  SLBP     = 2,  #     SLBP   7884
  FIP1L1   = 1,  #   FIP1L1  81608
  LSM11    = 2,  #    LSM11 134353
  CASP8AP2 = 2,  # CASP8AP2   9994
  CPSF4    = 1, #    CPSF4  10898
  ERI1     = 2,  #     ERI1  90459
  CPSF1    = 1, #    CPSF1  29894
  CSTF3    = 1,  #    CSTF3   1479
  CLP1     = 1,  #     CLP1  10978
  CPSF7    = 1,  #    CPSF7  79869
  PCF11    = 1,  #    PCF11  51585
  CPSF6    = 1,  #    CPSF6  11052
  SNRPF    = 2,  #    SNRPF   6636
  PABPN1   = 1,  #   PABPN1   8106
  CPSF2    = 3, #    CPSF2  53981
  PAPOLA   = 1,  #   PAPOLA  10914
  RBBP6    = 1,  #    RBBP6   5930
  NUDT21   = 1,  #   NUDT21  11051
  SYMPK    = 3,  #    SYMPK   8189
  ZNF473   = 2,  #   ZNF473  25888
  SNRPB    = 2,  #    SNRPB   6628
  CSTF1    = 1,  #    CSTF1   1477
  SNRPD3   = 2,  #   SNRPD3   6634
  CSTF2    = 3  #    CSTF2   1478
)
```

### TCGA studies

```{r study, echo = TRUE, results="verbatim"}
study_lihc_filename = "tcga_studies/study_TCGA-LIHC_trscr.rds"
if (!exists("study_lihc")) {
  print("Loading study_lihc...")
  study_lihc = readRDS(study_lihc_filename)  
}
s = study_lihc
idx_features = intersect(rownames(features), rownames(s$data))
print(table(study_lihc$exp_grp$main_gse_number, study_lihc$exp_grp$tissue_status))
```

### Gene expression profiles


```{r, fig.height=3}
plot.new()
legend("bottomleft", col=c("orange", "yellow", "green"), pch=15, c("complex 1", "complex 1 & 2", "complex 2"), bty="n")
legend("bottomright", col=c("grey20", "grey80"), pch=15, c("normal", "tumoral"), bty="n")
```

### Raw counts dataset

```{r echo=TRUE, collapse=TRUE, results='asis'}
raw_counts <- s$stuffs$raw_counts
dim(raw_counts)
knitr::kable(raw_counts[1:6,1:4], align = "c", caption = "Raw counts: 6 genes × 4 samples")
```

# Data Normalisation 

## RPM

RPM (or CPM) is a common normalization method based on a transcript expression unit. It accounts for biases due to sequencing depth and is commonly used for cutoff in independent filtering.

### Formula / script

To calculate RPM the formula consists of dividing the number of raW counts by the total number of reads (or library size) and multipliying by a 1 million factor.

EdgeR has it's own cpm-calculating function included in the package. This function calulates the log-cpm of counts. However, these methods don't differ much.

In this study we calculate RPM using EdgeR's cpm() function. This method differs from standard RPM calculation because it calculates the log-cpm.

Log RPM: 

```{r, eval=TRUE, echo=TRUE}
cpm <- edgeR::cpm(raw_counts)
cpm[1:6, 1:6]
```

Standard RPM: 

```{r, eval=TRUE, echo=TRUE}
rpm_sf <- colSums(raw_counts)/10^6
rpm <- t(t(raw_counts)/rpm_sf)
(rpm)[1:6, 1:6]
```

Here we observe that both log rpm and standard rpm counts are very similar.

```{r, eval=TRUE, echo=TRUE}
plot(log2(rpm[,1]+1), log2(cpm[,1]+1))
```

### Normalized Data

```{r echo=FALSE, collapse=TRUE, results='asis'}
knitr::kable(rpm[1:6,1:4], align = "c", caption = "RPM: 6 genes × 4 samples")
```

### Heatmaps

```{r, eval=TRUE, echo=FALSE, fig.height = 9}
data <- log2(rpm+1)[idx_features,]
rpm_hm = dmethr::plot_expr_hm(data, 
  normalization="zscore_rows", 
  hcmeth_rows="cor"                ,
  csc=c("grey20", "grey80")[as.factor(s$exp_grp[colnames(data),]$tissue_status)],
  rsc=c("orange", "green", "yellow")[complex[rownames(data)]],
  main = "RPM")
```

### Clusters

RPM Clusters: 

```{r, eval=TRUE, echo=TRUE}
bar <- cutree(rpm_hm$hc_row, k = 4)
bar

names(bar)

rpm_clust_A = names(bar)[bar==1]
rpm_clust_B = names(bar)[bar==2]
rpm_clust_C = names(bar)[bar==3]
rpm_clust_D = names(bar)[bar==4]

```

<!-- ## RPKM -->

<!-- ### Formula/Script -->


<!-- ```{r} -->
<!-- rpkm = s$stuffs$rpkm_data -->
<!-- ``` -->


<!-- ### Normalized Data -->

<!-- ```{r echo=FALSE, collapse=TRUE, results='asis'} -->
<!-- knitr::kable(rpkm[1:6,1:4], align = "c", caption = "RPKM: 6 genes × 4 samples") -->
<!-- ``` -->

<!-- ### Heatmap -->

<!-- ```{r, fig.height=9} -->
<!-- data <- log2(rpkm+1)[idx_features,] -->
<!-- rpkm_hm = dmethr::plot_expr_hm(data,  -->
<!--   normalization="zscore_rows",  -->
<!--   hcmeth_rows="cor"                , -->
<!--   csc=c("grey20", "grey80")[as.factor(s$exp_grp[colnames(data),]$tissue_status)], -->
<!--   rsc=c("orange", "green", "yellow")[complex[rownames(data)]], main = "RPKM") -->
<!-- ``` -->

<!-- ### Clusters -->

<!-- Because RPKM takes gene langth into account, we won't be focusing on clustering using this method. --- Can't calculate size factor --- -->

## DESeq2

DESeq2 is a standard normalization method used for differential expression analysis. It is based on the RLE method (Relative Log Expression) and accounts for biases such as sequencing depth, library composition and PCR affinity / RNA composition.

### Formula/Script

```{r, eval=TRUE, echo=TRUE}
countData <- raw_counts
colData <- data.frame(id=colnames(countData))
dds <- DESeq2::DESeqDataSetFromMatrix(countData=countData, colData=colData, design= ~ id)
dds <- DESeq2::estimateSizeFactors(dds)
deseq2_sf <- dds$sizeFactor
deseq2 <- DESeq2::counts(dds, normalized=TRUE)
```

### Normalized Data

```{r echo=FALSE, collapse=TRUE, results='asis'}
knitr::kable(deseq2[1:6,1:4], align = "c", caption = "DESeq2: 6 genes × 4 samples")
```

### Heatmap

```{r, fig.height=9}
data <- log2(deseq2+1)[idx_features,]
deseq2_hm = dmethr::plot_expr_hm(data, 
  normalization="zscore_rows", 
  hcmeth_rows="cor"                ,
  csc=c("grey20", "grey80")[as.factor(s$exp_grp[colnames(data),]$tissue_status)],
  rsc=c("orange", "green", "yellow")[complex[rownames(data)]], main = "DESeq2")
```

### Clusters

DESeq2 Clusters: 

```{r, eval=TRUE, echo=TRUE}
bar <- cutree(deseq2_hm$hc_row, k = 4)
bar

names(bar)

deseq2_clust_A = names(bar)[bar==1]
deseq2_clust_B = names(bar)[bar==2]
deseq2_clust_C = names(bar)[bar==3]
deseq2_clust_D = names(bar)[bar==4]
```

## EdgeR

EdgeR is a more robust method that competes with DESeq2. EdgeR uses a TMM method to normalize counts (Trimmed Mean of M-values) and accounts for the same biases as DESeq2 such as library composition, sequencing depth and PCR affinity / RNA composition.TMM is a method that calculates size factors by first selecting a reference sample then calculating pseudo size factors using the log of the reference_sample over current sample ratio, and finally trimming the most extreme ratios and most influential genes. This way, EdgeR only takes into account differentially expressed genes and ignores the influence of tissue-specific genes.

### Formula/Script

```{r, eval=TRUE, echo=TRUE}
edgeRnorm <- function(rc){
    nf <- edgeR::calcNormFactors(rc)
    nc <- rc
    for(i in 1:length(nf)){
        nc[,i] <- nc[,i]*nf[i]
    }
    return(nc)
}
data <- raw_counts
edger <- edgeRnorm(data)
s$stuffs$edger_data <- edger
edger_sf <- edgeR::calcNormFactors(data, method = "TMM")
```

### Normalized Data

```{r echo=FALSE, collapse=TRUE, results='asis'}
knitr::kable(edger[1:6,1:4], align = "c", caption = "EdgeR: 6 genes × 4 samples")
```

### Heatmap

```{r, eval=TRUE, echo=TRUE, fig.height = 9}
data <- log2(edger)[idx_features,]
edger_hm = dmethr::plot_expr_hm(data, 
  normalization="zscore_rows", 
  hcmeth_rows="cor"                ,
  csc=c("grey20", "grey80")[as.factor(s$exp_grp[colnames(data),]$tissue_status)],
  rsc=c("orange", "green", "yellow")[complex[rownames(data)]],
  main = "EdgeR")
```

EdgeR Clusters

```{r, eval=TRUE, echo=TRUE}
bar <- cutree(edger_hm$hc_row, k = 4)
bar

names(bar)

edger_clust_A = names(bar)[bar==1]
edger_clust_B = names(bar)[bar==2]
edger_clust_C = names(bar)[bar==3]
edger_clust_D = names(bar)[bar==4]
```

## RPM40

### Formula

### Data

```{r, eval=TRUE, echo=TRUE}
rpm40_sf <- (colSums(raw_counts)/10^6)*40
rpm40 <- t(t(raw_counts)/rpm40_sf)
(rpm40)[1:6, 1:6]
#(rpm)[1:6, 1:6]
```

### Heatmap

```{r, eval=TRUE, echo=FALSE, fig.height = 9}
data <- log2(rpm40+1)[idx_features,]
rpm40_hm = dmethr::plot_expr_hm(data, 
  normalization="zscore_rows", 
  hcmeth_rows="cor"                ,
  csc=c("grey20", "grey80")[as.factor(s$exp_grp[colnames(data),]$tissue_status)],
  rsc=c("orange", "green", "yellow")[complex[rownames(data)]],
  main = "RPM40")
```

### Clusters

```{r, eval=TRUE, echo=TRUE}
bar <- cutree(rpm40_hm$hc_row, k = 4)
bar

names(bar)

rpm40_clust_A = names(bar)[bar==1]
rpm40_clust_B = names(bar)[bar==2]
rpm40_clust_C = names(bar)[bar==3]
rpm40_clust_D = names(bar)[bar==4]
```

# Comparison

We create a tab in which we input the clustering data.And we create a data-frame with size factors of each method.

### Plots

```{r, fig.height=9}
df_sf <- cbind(rpm_sf = rpm_sf, deseq2_sf=deseq2_sf, edger_sf=edger_sf)
dim(df_sf)
pairs(df_sf)

epimedtools::et_pairs(df_sf)
# INSTALL!!!!

```

```{r, fig.height=9}
df_sample1 <- cbind(rpm_sample1=rpm[,1], deseq2_sample1=deseq2[,1], edger_sample1=edger[,1])
dim(df_sample1)
pairs(log2(df_sample1+1))

# epimedtools::et_pairs(df_sf)
# INSTALL!!!!

```

```{r}

tmptab <- s$platform[idx_features,]

tmptab$rpm_clust = NA
tmptab$rpm40_clust = NA
tmptab$deseq2_clust = NA
tmptab$edger_clust = NA

# RPM

tmptab[rpm_clust_A,]$rpm_clust = "rpm_A"
tmptab[rpm_clust_B,]$rpm_clust = "rpm_B"
tmptab[rpm_clust_C,]$rpm_clust = "rpm_C"
tmptab[rpm_clust_D,]$rpm_clust = "rpm_D"

# DESeq2

tmptab[deseq2_clust_A,]$deseq2_clust = "deseq2_A"
tmptab[deseq2_clust_B,]$deseq2_clust = "deseq2_B"
tmptab[deseq2_clust_C,]$deseq2_clust = "deseq2_C"
tmptab[deseq2_clust_D,]$deseq2_clust = "deseq2_D"

# EdgeR

tmptab[edger_clust_A,]$edger_clust = "edger_A"
tmptab[edger_clust_B,]$edger_clust = "edger_B"
tmptab[edger_clust_C,]$edger_clust = "edger_C"
tmptab[edger_clust_D,]$edger_clust = "edger_D"

# RPM40

tmptab[rpm40_clust_A,]$rpm40_clust = "rpm40_A"
tmptab[rpm40_clust_B,]$rpm40_clust = "rpm40_B"
tmptab[rpm40_clust_C,]$rpm40_clust = "rpm40_C"
tmptab[rpm40_clust_D,]$rpm40_clust = "rpm40_D"

```

### Cluster Tables

```{r, results='asis'}

rpm_deseq2_clust_table <- table(tmptab$rpm_clust, tmptab$deseq2_clust)
rpm_edger_clust_table <- table(tmptab$rpm_clust, tmptab$edger_clust)
edger_deseq2_clust_table <- table(tmptab$edger_clust, tmptab$deseq2_clust)
rpm40_deseq2_clust_table <- table(tmptab$rpm40_clust, tmptab$deseq2_clust)
rpm40_edger_clust_table <- table(tmptab$rpm40_clust, tmptab$edger_clust)

knitr::kable(rpm_deseq2_clust_table, align = "c", caption = "RPM vs DESeq2")
knitr::kable(rpm_edger_clust_table, align = "c", caption = "RPM vs EdgeR")
knitr::kable(edger_deseq2_clust_table, align = "c", caption = "EdgeR VS DESeq2")
knitr::kable(rpm40_deseq2_clust_table, align = "c", caption = "RPM40 vs DESeq2")
knitr::kable(rpm40_deseq2_clust_table, align = "c", caption = "RPM40 vs EdgeR")

```

```{r, eval=TRUE, echo=TRUE}
#layout(matrix(1:3,1), respect = TRUE)
plot(edger_sf,rpm_sf, main = "EdgeR vs RPM (Size Factors)", xlab = "EdgeR TMM Size Factors", ylab = "RPM Size Factors")
dim(edger)
plot(log2(edger+1)[,1], log2(rpm+1)[,1], main = "EdgeR vs RPM: inter-sample", xlab = "EdgeR TMM Counts", ylab = "RPM Counts")
```

In this case, there is also a 40-fold difference between RPM and EdgeR size factors

```{r, eval=TRUE, echo=TRUE}
plot(log2(edger+1)[,1], log2(rpm*40+1)[,1], main = "EdgeR vs RPM40: inter-sample (corrected)", xlab = "log2 EdgeR TMM Counts", ylab = "log2 RPM40 Counts")
```

### Cluster comparison table

## DESeq2 vs EdgeR

### Plot

```{r, eval=TRUE, echo=TRUE}
# layout(matrix(1:3,1), respect = TRUE)
plot(edger_sf,deseq2_sf, main = "EdgeR vs DESeq2 (Size Factors)", xlab = "EdgeR TMM Size Factors", ylab = "DESeq2 Size Factors")
dim(edger)

plot(log2(edger+1)[,1], log2(deseq2+1)[,1], main = "EdgeR vs RPM: inter-sample", xlab = "log2 EdgeR TMM Counts", ylab = "log2 RPM Counts")
```

# Conclusion and Discussion

# References

## Articles

The portrait of liver cancer is shaped by mitochondrial genetics


## Session Info

```{r, eval=TRUE, echo=TRUE}
sessionInfo()
```
